---
title: "Piple Performance"
author: "John Mount"
date: "7/7/2017"
output:
  md_document:
    variant: markdown_github
---

Some timings for [`%.>%`](http://www.win-vector.com/blog/2017/07/in-praise-of-syntactic-sugar/) ("dot arrow").

Keep in mind for any *serious* application the calculation time on data will far dominate any piping overhead, but it is fun to look.

So we will compare:

 * `magrittr*` `magrittr::%>%` substitution.
 * `DotArrow*` `wrapr::%.>%` substitution.
 * `HappyArrow*` `wrapr::%:>%` substitution.
 * `BizarroPipe*` `->.;` substitution.
 
```{r generator, include=FALSE, echo=FALSE}
# build source code for fns of size k
# build source code for fns of size k
buildFnsK <- function(k) {
  fs <- c("5", rep("sin(.)", k))
  fMap <- list('magrittr' = '%>%' , 
               'DotArrow' = '%.>%', 
               'HappyArrow' = '%:>%', 
               'BizarroPipe' = '->.;')
  fns  <- lapply(names(fMap),
                 function(fn) {
                   op <- fMap[[fn]]
                   paste0(fn, '_', k, ' <- function() {\n ',
                          paste(fs, collapse = paste0(' ', op, '\n   ')),
                          '\n}\n\n')
                   
                 })
  paste(fns, collapse= '\n\n')
}


ftext <- paste(
  buildFnsK(1),
  buildFnsK(2),
  buildFnsK(5),
  buildFnsK(10),
  buildFnsK(15),
  buildFnsK(20),
  buildFnsK(25),
  buildFnsK(50),
  collapse = "\n\n")

fileConn<-file("pGenFns.R")
writeLines(ftext, fileConn)
close(fileConn)
```

```{r defs}
library("microbenchmark")
library("wrapr")
library("rlang")
suppressPackageStartupMessages(library("ggplot2"))
suppressPackageStartupMessages(library("dplyr"))

# load generated examples
prevNames <- ls()
source("pGenFns.R")
genFns <- setdiff(ls(), c(prevNames, 'prevNames', 'genFns'))

print(BizarroPipe_5)

print(DotArrow_5)

print(HappyArrow_5)

print(magrittr_5)

BizarroPipe_10()

DotArrow_10()

HappyArrow_10()

magrittr_10()
```

```{r timings}
cmd <- parse(text=paste0(
  "microbenchmark(\n ",
  paste(paste0(genFns,'()'), collapse=',\n '),
  ", 
  times=1000L
  )\n"
))

print(cmd)

bm <- eval(cmd)
print(bm)
autoplot(bm)
```

```{r replot}
d <- as.data.frame(bm)
d$size <- as.numeric(gsub("[^0-9]+", "", d$expr))
d$fn <- gsub("[_0-9].*$", "", d$expr)

d$fn <- reorder(d$fn, d$time)
ggplot(d, aes(x=fn, y=time, color=fn)) + 
  geom_violin() + 
  scale_y_log10() + 
  facet_wrap(~size, labeller="label_both") + 
  coord_flip() + 
  xlab("method") +
  ylab("time NS") +
  theme(legend.position = 'none') +
  scale_color_brewer(palette = 'Dark2') +
  ggtitle("distribution of runtime as function of method and problem size",
          subtitle = "log scale")
```

```{r calculate}
# new verb that records listnames in a column
bind_rows_named <- function(dlist, destinationColumn) {
  res <- bind_rows(dlist)
  res[[destinationColumn]] <- names(dlist)
  res
}

# fit a linear function for runtime as a function of size
# per group.
dfits <- d %.>%
  split(., .$fn) %.>%
  lapply(., 
         function(di) { 
           lm(time ~ size, data=di) 
         }) %.>%
  lapply(., coefficients) %.>%
  lapply(., 
         function(ri) {
           data.frame(Intercept= ri[["(Intercept)"]],
                      size= ri[['size']])
         }) %.>%
  bind_rows_named(., 'fn')


# "Intercept" is roughly start-up cost 
# "size" is slope or growth rate
print(dfits)


ratio <- dfits$size[dfits$fn=='magrittr'] / dfits$size[dfits$fn=='DotArrow']
print(ratio)
```

Overall:

DotArrow is about `r format(ratio, digits=2)` times faster than magrittr on large pipelines, though this cost will be unnoticeable with in any significant workload.

